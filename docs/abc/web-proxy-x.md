
# 代理上网准入检测实验

情景：按照代理软件默认的安装方式，登录帐号连接节点发现软件报错，并提示乱码，软件日志难以找到，去切实排查原因...第一想法是软件字符编码及兼容性问题，可win7、win10测试无效，即使设置了UTF-8编码，情况依旧；从以前经验想当然认为“乱码不影响使用（连接、功能逻辑操作）”，这个时候也是一头雾水。

![image-20201215112132923.png](https://i.loli.net/2020/12/15/MXQB5KS8s4UgnDi.png)

在这个时候联系了售后才了解到不能含特殊字符、空格的目录如常见的：

```cmd
C:\Program Files
C:\Program Files (x86)
```

....O__O "…，按照软件说明安装，登录连接服务器确实成功的。虽然连接成功，但访问Google还是被阻断了有些异常，联系了厂商客服，他们也表示他们的提供服务器没有问题，页面空白如下图现象...为了临时能让同事连接上网，使用ss连接依旧如此。（该图为过程复盘）

![Catch_12-03-11-39-37_.jpg](https://i.loli.net/2020/12/03/o81uC4zR6LipQYd.jpg)

然而在管理员主机这边却是可以的，这又是怎么回事呢？

![image-20201203114350647.png](https://i.loli.net/2020/12/03/QtNTdDCWUV4BAMO.png)

**初步了解**原来是上网帐号权限问题，管理员访问网站是不受限的；所带来的疑问点是为什么实验同学明明勾选了代理工具，但用代理工具却又访问不了Google这般类型的搜索页面呢？

防火墙对代理、VPN程序的协议识别机制有关，由于年限原因一些新型代理、VPN使用新型的协议导致无法识别相关的代理工具，也是存在这种可能性。

![2020-12-03_120742.png](https://i.loli.net/2020/12/03/K5FiSZtICswgycp.png)

**通过深入发现**设置LAN->WAN并制定端口范围的访问方式，限制代理、VPN翻墙。

![2020-12-03_121845.png](https://i.loli.net/2020/12/03/1PbhsDdxj3nKwQE.png)

不在上图中准入系统设置的端口范围内的实验同学，该同学代理界面节点端口信息如下。

![089EF.png](https://i.loli.net/2020/12/05/KI65dAZFyeWDaOm.png)

所以这就是此次访问异常的原因所在；泛泛来说，学校学生一般有百来个，不同专业班级也有十几个左右及以上，根据相关需求也得制定不同的上网规则。将上网规则集合在一起组成策略，将各组的上网行为规范应用于策略，极大方便了对校园学生的上网行为管理。

**浏览器页面的启用端口疑惑**

深信服访问准入设备的开放端口限制，浏览器所打开的各个站点是是否端口各不相同？于是参考[知乎-浏览器对于每个网页会使用不同的端口号吗？](https://www.zhihu.com/question/401686199)的两篇回答得出结论：

各个站点的网址服务器端口不会变，默认设置443、80，加端口号都是额外设置的；客户端，也就是我们的浏览器 ，本质上是启用多个独立程序打开相应所访问的多个页面，与此同时， 也就有了相应进程与多个端口。并不是访问各个网址的端口各不相同。

## 代理上网逻辑网络

大家对我校学生及组织难以理解，也是，那么我就以毕业的社会人视角比方吧，最开始用户是通过互联网联系到能够直连外网的代理商访问外网

![image-20201203142709439.png](https://i.loli.net/2020/12/03/4kM5mL2Dyv9IWhQ.png)


用户与代理商双方建立连接关系，也是需要相互之间信任验证的，不建立信任验证，谁都可以建立连接就乱套了。于是就有了客户端与服务器端完成帐号登录与密码验证这一过程。建立信任关系后，代理商就如同用户的下手助理，接代用户的意愿去完成一系列的行为操作。

代理上网拓扑流程如下：

![image-20201203162752377.png](https://i.loli.net/2020/12/03/TjZLyhg1vBxuAVs.png)


### 附：网页代理原理

网页代理服务器又称为在线代理或者叫线上代理，是一种在网页上运行的代理服务器程序，其不用任何设置，输入网址选择好代理服务器便可以访问的优点已经成为时下最流行的代理访问方式。网页代理是常见的一种代理程序。网页代理给客户端提供远程网站上的网页和文件的高速缓存，使客户端可以更加快速安全的浏览远程网站。一些网页代理网站保持每天更新以保证速度。

浏览器客户端提交网址的时候，代理程序开始在当前服务器寻找远程网站的缓存网页和网站，找到目标网站后，代理程序马上将网站数据返回到用户的浏览器客户端；如果当前服务器没有该远程服务器的缓存，代理程序则会自动读取远程网站，将远程网站的资料提交给客户端，同时将资料缓存提供给下一次的浏览需求。

代理程序会根据缓存的时间、大小和提取记录自动删除缓存。删除的方法有两种，一种是删除保存最久的资料，一种是删除最少提取的缓存。这两种方法也可以结合使用。

![2018-05-10-192753.png](https://i.loli.net/2020/12/15/6TeZqCQ3c2gxous.png)
